<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồi Âm CMS - Automation</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #38bdf8; --text: #f8fafc; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; margin: 0; }
        
        /* Layout */
        .sidebar { width: 250px; background: #020617; padding: 20px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 5px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px; border-radius: 8px; color: #94a3b8; cursor: pointer; font-weight: 600; display: flex; gap: 10px; align-items: center; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--surface); color: #fff; }
        .nav-item.active { color: var(--primary); }

        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid #334155; max-width: 600px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Form Elements */
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 24px; }
        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #94a3b8; font-weight: 600; text-transform: uppercase; }
        input, select { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #fff; font-size: 15px; outline: none; transition: 0.2s; box-sizing: border-box; }
        input:focus { border-color: var(--primary); }
        
        /* Magic Button */
        .btn-magic { position: absolute; right: 5px; top: 32px; background: var(--primary); color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.2s; }
        .btn-magic:hover { transform: scale(1.05); box-shadow: 0 0 10px var(--primary); }

        .btn-submit { width: 100%; padding: 16px; background: var(--primary); color: #000; font-weight: 800; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-submit:hover { opacity: 0.9; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: #334155; color: #fff; padding: 15px; border-radius: 8px; transform: translateX(200%); transition: 0.3s; z-index: 200; border-left: 4px solid var(--primary); }
        .toast.show { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card" style="width: 400px;">
            <div style="text-align: center; margin-bottom: 20px; font-size: 40px; color: var(--primary);"><i class="fa-solid fa-shield-halved"></i></div>
            <h2 style="text-align: center;">Đăng Nhập Admin</h2>
            <input type="password" id="pass" placeholder="Nhập mật khẩu..." style="margin-bottom: 20px;">
            <button class="btn-submit" onclick="login()">Truy cập</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-wand-magic-sparkles"></i> HỒI ÂM AUTO</div>
        <div class="nav-item active"><i class="fa-solid fa-plus-circle"></i> Thêm Truyện</div>
        <div class="nav-item" onclick="alert('Tính năng đang phát triển')"><i class="fa-solid fa-list"></i> Danh sách</div>
    </div>

    <div class="main">
        <div class="card">
            <h2>Thêm Truyện Mới</h2>
            
            <div class="input-group">
                <label>Dán Link Youtube vào đây (Tự động bắt link)</label>
                <input type="text" id="inp-url" placeholder="https://www.youtube.com/playlist?list=PL..." onpaste="setTimeout(autoFetch, 100)">
                <button class="btn-magic" onclick="autoFetch()"><i class="fa-solid fa-bolt"></i> Lấy thông tin</button>
            </div>

            <div class="input-group">
                <label>Tên Truyện (Tự động điền)</label>
                <input type="text" id="inp-name" placeholder="...">
            </div>

            <div class="input-group">
                <label>Playlist ID (Tự động tách)</label>
                <input type="text" id="inp-pid" placeholder="..." readonly style="background: #1e293b; color: #aaa;">
            </div>

            <div class="input-group">
                <label>Phân Loại</label>
                <select id="inp-cat">
                    <option value="Chủ Thụ">Chủ Thụ</option>
                    <option value="Chủ Công">Chủ Công</option>
                    <option value="Hỗ Công">Hỗ Công</option>
                    <option value="Vô CP">Vô CP</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <button class="btn-submit" onclick="saveToDB()">LƯU VÀO KHO</button>
        </div>
    </div>

    <div id="toast" class="toast">Thông báo</div>

<script>
    const db = supabase.createClient('https://lpeijpxqelyljkdjyfil.supabase.co', 'sb_publishable_n95DoJPIr7_KgktuE5ilZg_7a0ICkcT');

    function login() {
        if(document.getElementById('pass').value === 'hoiam20102003') document.getElementById('login-screen').style.display = 'none';
        else alert('Sai mật khẩu');
    }

    // --- LOGIC THÔNG MINH ---
    async function autoFetch() {
        const url = document.getElementById('inp-url').value;
        if (!url) return showToast('Vui lòng dán link Youtube!');

        // 1. Tự tách ID Playlist từ Link
        let listId = "";
        try {
            const urlObj = new URL(url);
            listId = urlObj.searchParams.get("list");
        } catch (e) {
            // Nếu link không chuẩn, thử regex
            const match = url.match(/list=([a-zA-Z0-9_-]+)/);
            if(match) listId = match[1];
        }

        if(listId) {
            document.getElementById('inp-pid').value = listId;
            showToast('Đã tách thành công ID Playlist!');
            
            // 2. Thử lấy tên từ oEmbed (Cơ chế No-Code)
            try {
                // Dùng dịch vụ noembed (miễn phí, không cần key) để lấy tiêu đề
                const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/playlist?list=${listId}`);
                const data = await res.json();
                if(data.title) {
                    document.getElementById('inp-name').value = data.title;
                    showToast('Đã lấy được tên truyện!');
                } else {
                    // Fallback nếu là link video trong playlist
                    document.getElementById('inp-name').placeholder = "Không lấy được tên, vui lòng nhập tay...";
                }
            } catch(err) {
                console.log("Auto-fetch error (CORS or Private)", err);
            }
        } else {
            showToast('Link không hợp lệ! Phải có chữ "list=..."');
        }
    }

    async function saveToDB() {
        const name = document.getElementById('inp-name').value;
        const pid = document.getElementById('inp-pid').value;
        const cat = document.getElementById('inp-cat').value;
        
        if(!name || !pid) return alert('Thiếu thông tin!');

        const btn = document.querySelector('.btn-submit');
        btn.innerText = "Đang lưu...";
        
        const { error } = await db.from('playlists').insert([{ name: name, category: cat, playlist_id: pid }]);
        
        if(error) alert('Lỗi: ' + error.message);
        else {
            showToast('Thêm thành công!');
            document.getElementById('inp-url').value = '';
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-pid').value = '';
            btn.innerText = "LƯU VÀO KHO";
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
</script>
</body>
</html>
