<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">
    <title>Kho Truy·ªán ƒêam M·ªπ - Pro Player V2</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #090909;
            --bg-card: #181818;
            --bg-hover: #2a2a2a;
            --primary: #1db954;
            --text-main: #ffffff;
            --text-sub: #a7a7a7;
            --bar-height: 90px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            overflow: hidden;
            display: flex; height: 100vh;
            user-select: none; /* Tr√°nh b√¥i ƒëen text khi thao t√°c */
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 240px; background: #000; padding: 24px;
            display: flex; flex-direction: column; gap: 20px;
            border-right: 1px solid #222;
        }
        .logo { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px; margin-bottom: 20px; color: var(--primary); letter-spacing: -0.5px;}
        .nav-item { color: var(--text-sub); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 15px; padding: 12px 0; transition: 0.2s; font-size: 14px;}
        .nav-item:hover, .nav-item.active { color: var(--text-main); }
        .nav-item.active i { color: var(--primary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            background: linear-gradient(180deg, #222 0%, var(--bg-dark) 40%);
            overflow-y: auto; padding: 20px 30px; padding-bottom: 160px;
            scrollbar-width: thin; scrollbar-color: #444 #121212;
        }
        h2 { margin-top: 10px; font-size: 28px; letter-spacing: -0.5px;}
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        
        .card { 
            background: var(--bg-card); padding: 16px; border-radius: 8px; cursor: pointer; 
            transition: all 0.3s ease; position: relative; border: 1px solid transparent;
        }
        .card:hover { background: var(--bg-hover); transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .card-video-box { 
            width: 100%; aspect-ratio: 16/9; background: #333; border-radius: 6px; 
            margin-bottom: 12px; overflow: hidden; position: relative; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .card-video-box img { width: 100%; height: 100%; object-fit: cover; }
        .play-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; }
        .card:hover .play-overlay { opacity: 1; }
        .play-icon-big { font-size: 48px; color: var(--primary); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.6)); transform: scale(0.8); transition: 0.2s; }
        .card:hover .play-icon-big { transform: scale(1); }
        .card-title { font-weight: 700; font-size: 15px; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;}
        .card-desc { font-size: 13px; color: var(--text-sub); }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--bar-height);
            background: #000000; border-top: 1px solid #222;
            display: flex; flex-direction: column; z-index: 100;
        }
        .progress-container { width: 100%; height: 4px; background: #333; cursor: pointer; position: relative; transition: height 0.1s;}
        .progress-container:hover { height: 6px; }
        .progress-filled { height: 100%; background: var(--primary); width: 0%; border-radius: 0 4px 4px 0; position: relative; }
        .progress-thumb { width: 12px; height: 12px; background: white; border-radius: 50%; position: absolute; right: -6px; top: 50%; transform: translateY(-50%); opacity: 0; transition: 0.2s; }
        .progress-container:hover .progress-thumb { opacity: 1; }

        .player-controls-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex: 1; }
        
        .player-left { display: flex; align-items: center; width: 30%; gap: 15px; }
        .mini-player-thumb { width: 56px; height: 56px; border-radius: 4px; background: #333; overflow: hidden; flex-shrink: 0; }
        .mini-player-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .current-info h4 { margin: 0; font-size: 14px; color: white; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .current-info p { margin: 4px 0 0; font-size: 11px; color: var(--text-sub); }

        .player-center { width: 40%; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .controls { display: flex; align-items: center; gap: 24px; }
        .btn-control { background: none; border: none; color: #b3b3b3; font-size: 18px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-control:hover { color: white; }
        .btn-play { width: 38px; height: 38px; background: white; border-radius: 50%; color: black; font-size: 18px; transition: 0.2s; display: flex; align-items: center; justify-content: center;}
        .btn-play:hover { transform: scale(1.05); background: #eee; }
        .time-display { font-size: 11px; color: #b3b3b3; font-variant-numeric: tabular-nums; }

        .player-right { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 15px; }

        /* --- DRAWER --- */
        .chapter-drawer {
            position: fixed; right: -320px; top: 0; bottom: var(--bar-height); width: 320px;
            background: #121212; border-left: 1px solid #333; z-index: 90;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: -5px 0 30px rgba(0,0,0,0.7);
        }
        .chapter-drawer.open { right: 0; }
        .drawer-header { padding: 24px; border-bottom: 1px solid #282828; font-weight: 700; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .drawer-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chapter-item { padding: 14px; border-radius: 6px; cursor: pointer; color: #ccc; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .chapter-item:hover { background: #2a2a2a; color: white; }
        .chapter-item.active { background: #222; color: var(--primary); font-weight: 600; }
        
        /* Speed Menu */
        .speed-menu {
            position: absolute; bottom: 70px; right: 0; background: #282828; 
            border-radius: 8px; padding: 8px; display: none; flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); min-width: 120px;
        }
        .speed-menu.show { display: flex; animation: fadeIn 0.2s; }
        .speed-opt { padding: 10px; font-size: 13px; color: #ddd; cursor: pointer; border-radius: 4px; }
        .speed-opt:hover { background: #3e3e3e; color: white; }
        .speed-opt.active { color: var(--primary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .main-content { padding: 15px; padding-bottom: 150px;}
            .player-bar { height: auto; padding-bottom: 15px; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
            .player-controls-wrapper { flex-direction: column; gap: 12px; padding: 8px 15px; }
            .player-left { width: 100%; }
            .player-center { width: 100%; flex-direction: row; justify-content: space-between; }
            .player-right { display: none; } /* Mobile ·∫©n volume, ƒë∆∞a speed v√†o drawer ho·∫∑c n√∫t ri√™ng */
            .controls { gap: 20px; }
            .chapter-drawer { width: 85%; }
            /* Th√™m n√∫t speed tr√™n mobile center */
            .mobile-speed { display: block !important; }
        }
        .mobile-speed { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-headphones-simple"></i> H·ªíI √ÇM PRO</div>
        <div class="nav-item active"><i class="fa-solid fa-house"></i> Trang ch·ªß</div>
        <div class="nav-item"><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch s·ª≠</div>
        <div id="youtube-iframe" style="width: 1px; height: 1px; opacity: 0; pointer-events: none;"></div>
    </div>

    <div class="main-content">
        <h2>H√¥m nay nghe g√¨?</h2>
        <div id="loading" style="text-align: center; margin-top: 40px; color: #666;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang t·∫£i kho truy·ªán...
        </div>
        <div class="grid" id="playlist-container"></div>
    </div>

    <div class="chapter-drawer" id="chapter-drawer">
        <div class="drawer-header">
            <span>Danh s√°ch t·∫≠p</span>
            <i class="fa-solid fa-xmark" style="cursor: pointer; padding: 5px;" onclick="toggleDrawer()"></i>
        </div>
        <div class="drawer-list" id="chapter-list-content"></div>
    </div>

    <div class="player-bar">
        <div class="progress-container" id="progress-container" onclick="seekTo(event)">
            <div class="progress-filled" id="progress-filled">
                <div class="progress-thumb"></div>
            </div>
        </div>

        <div class="player-controls-wrapper">
            <div class="player-left">
                <div class="mini-player-thumb">
                    <img id="track-thumb" src="https://via.placeholder.com/150" alt="Thumb">
                </div>
                <div class="current-info">
                    <h4 id="track-name">S·∫µn s√†ng ph√°t</h4>
                    <p id="track-info">--:--</p>
                </div>
            </div>

            <div class="player-center">
                <div class="controls">
                    <button class="btn-control" onclick="prevTrack()"><i class="fa-solid fa-backward-step"></i></button>
                    <button class="btn-control" onclick="seek(-10)"><i class="fa-solid fa-rotate-left" style="font-size: 16px;"></i></button>
                    <button class="btn-play" id="play-btn" onclick="togglePlay()"><i class="fa-solid fa-play"></i></button>
                    <button class="btn-control" onclick="seek(10)"><i class="fa-solid fa-rotate-right" style="font-size: 16px;"></i></button>
                    <button class="btn-control" onclick="nextTrack()"><i class="fa-solid fa-forward-step"></i></button>
                </div>
                <div class="time-display" id="time-display">00:00 / 00:00</div>
            </div>

            <div class="player-right">
                <button class="btn-control" onclick="toggleDrawer()" title="Danh s√°ch t·∫≠p"><i class="fa-solid fa-list-ul"></i></button>
                <div style="position: relative;">
                    <button class="btn-control" onclick="toggleSpeedMenu()">
                        <span id="speed-btn-text" style="font-size: 12px; font-weight: 700; border: 1px solid #555; padding: 2px 6px; border-radius: 4px;">1x</span>
                    </button>
                    <div class="speed-menu" id="speed-menu">
                        <div class="speed-opt" onclick="setSpeed(0.5)">0.5x</div>
                        <div class="speed-opt" onclick="setSpeed(1.0)">1.0x (Chu·∫©n)</div>
                        <div class="speed-opt" onclick="setSpeed(1.25)">1.25x</div>
                        <div class="speed-opt" onclick="setSpeed(1.5)">1.5x</div>
                        <div class="speed-opt" onclick="setSpeed(2.0)">2.0x</div>
                        <div class="speed-opt" onclick="setSpeed(2.5)">2.5x</div>
                        <div class="speed-opt" onclick="setSpeed(3.0)">3.0x</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://lpeijpxqelyljkdjyfil.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_n95DoJPIr7_KgktuE5ilZg_7a0ICkcT';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let player;
    let isPlaying = false;
    let updateTimer;
    let currentPlaylistId = "";
    let currentPlaylistName = "";
    
    // --- L∆ØU TI·∫æN ƒê·ªò ---
    const STORAGE_KEY = 'hoiam_progress_v2';

    // --- 1. SETUP MEDIA SESSION (QUAN TR·ªåNG CHO PH√ÅT N·ªÄN) ---
    function setupMediaSession() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
            navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
            navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
            navigator.mediaSession.setActionHandler('seekbackward', () => seek(-10));
            navigator.mediaSession.setActionHandler('seekforward', () => seek(10));
        }
    }

    function updateMediaSessionInfo(index) {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: `T·∫≠p ${index + 1}`,
                artist: currentPlaylistName,
                album: 'H·ªìi √Çm ƒêam M·ªπ',
                artwork: [
                    { src: 'https://via.placeholder.com/512', sizes: '512x512', type: 'image/png' }
                ]
            });
        }
    }

    // --- 2. LOAD TH∆Ø VI·ªÜN ---
    async function loadLibrary() {
        const { data, error } = await db.from('playlists').select('*').order('id', { ascending: false });
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('playlist-container');

        if (data && data.length > 0) {
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                // D√πng ·∫£nh tƒ©nh Youtube ƒë·ªÉ nh·∫π h∆°n
                const thumbUrl = `https://i.ytimg.com/vi_webp/${item.playlist_id.split(',')[0] || 'hqdefault'}/maxresdefault.jpg`; 
                // X·ª≠ l√Ω playlist ID ƒë√¥i khi l√† list, l·∫•y ƒë·∫°i di·ªán ho·∫∑c d√πng placeholder n·∫øu c·∫ßn
                const bgImg = `https://i.ytimg.com/vi/mqdefault.jpg`; // Fallback image logic is complex with pure playlists

                div.innerHTML = `
                    <div class="card-video-box">
                        <img src="${bgImg}" onerror="this.src='https://via.placeholder.com/300x169?text=Audio'" />
                        <div class="play-overlay"><i class="fa-solid fa-circle-play play-icon-big"></i></div>
                    </div>
                    <div class="card-title">${item.name}</div>
                    <div class="card-desc">Danh s√°ch ph√°t</div>
                `;
                // Logic ·∫£nh ƒë·∫°i di·ªán playlist: C·∫ßn l·∫•y ID video ƒë·∫ßu ti√™n trong list m·ªõi chu·∫©n, ·ªü ƒë√¢y d√πng t·∫°m logic click
                div.onclick = () => loadTrackToPlayer(item.playlist_id, item.name, 0, 0);
                container.appendChild(div);
            });
        }
    }

    // --- 3. YOUTUBE API ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-iframe', {
            height: '100%', width: '100%',
            playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 0, 'fs': 0, 'rel': 0 },
            events: { 
                'onStateChange': onPlayerStateChange,
                'onReady': checkSavedProgress
            }
        });
        setupMediaSession();
    }

    // --- 4. PLAYER LOGIC ---
    function loadTrackToPlayer(playlistId, name, index = 0, startSeconds = 0, autoPlay = true) {
        currentPlaylistId = playlistId;
        currentPlaylistName = name;
        document.getElementById('track-name').innerText = name;
        document.getElementById('track-info').innerText = "ƒêang t·∫£i T·∫≠p " + (index + 1);
        
        // Update Thumb (L·∫•y t·∫°m ·∫£nh video)
        document.getElementById('track-thumb').src = "https://i.ytimg.com/vi/mqdefault.jpg";

        if(player && player.loadPlaylist) {
            if(autoPlay) {
                player.loadPlaylist({list: playlistId, listType: 'playlist', index: index, startSeconds: startSeconds});
            } else {
                player.cuePlaylist({list: playlistId, listType: 'playlist', index: index, startSeconds: startSeconds});
            }
            setTimeout(renderChapterList, 1500);
        }
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            isPlaying = true;
            updatePlayButton();
            startTimer();
            if(!window.saveInterval) window.saveInterval = setInterval(saveProgress, 10000);
            
            const idx = player.getPlaylistIndex();
            highlightChapter(idx);
            updateMediaSessionInfo(idx); // Update m√†n h√¨nh kh√≥a

        } else {
            isPlaying = false;
            updatePlayButton();
            clearInterval(updateTimer);
            if(event.data == YT.PlayerState.PAUSED) saveProgress();
        }
    }

    // --- 5. PROGRESS & CONTROLS ---
    function startTimer() {
        clearInterval(updateTimer);
        updateTimer = setInterval(() => {
            if (player && player.getCurrentTime) {
                const current = player.getCurrentTime();
                const duration = player.getDuration();
                if (duration > 0) {
                    const percent = (current / duration) * 100;
                    document.getElementById('progress-filled').style.width = percent + "%";
                    document.getElementById('time-display').innerText = formatTime(current) + " / " + formatTime(duration);
                    
                    // C·∫≠p nh·∫≠t media session position (quan tr·ªçng cho thanh tua tr√™n lock screen)
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: player.getPlaybackRate(),
                            position: current
                        });
                    }
                }
            }
        }, 500);
    }

    function togglePlay() { 
        if(!player) return; 
        if(isPlaying) player.pauseVideo(); 
        else player.playVideo(); 
    }
    
    function updatePlayButton() { 
        document.getElementById('play-btn').innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>'; 
    }
    function prevTrack() { if(player) player.previousVideo(); }
    function nextTrack() { if(player) player.nextVideo(); }
    
    function seekTo(event) {
        if (!player) return;
        const container = document.getElementById('progress-container');
        const rect = container.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        player.seekTo(percent * player.getDuration(), true);
    }
    function seek(sec) { if(player) player.seekTo(player.getCurrentTime() + sec, true); }

    // --- 6. DRAWER & SPEED ---
    function toggleDrawer() { document.getElementById('chapter-drawer').classList.toggle('open'); }
    function toggleSpeedMenu() { document.getElementById('speed-menu').classList.toggle('show'); }
    
    function setSpeed(rate) {
        if(player) player.setPlaybackRate(rate);
        document.getElementById('speed-btn-text').innerText = rate + "x";
        document.getElementById('speed-menu').classList.remove('show');
    }

    function renderChapterList() {
        if(!player) return;
        const listIds = player.getPlaylist(); // H√†m n√†y tr·∫£ v·ªÅ Array Video ID
        const container = document.getElementById('chapter-list-content');
        container.innerHTML = "";
        if(listIds) {
            listIds.forEach((id, idx) => {
                const item = document.createElement('div');
                item.className = 'chapter-item';
                item.id = 'chapter-' + idx;
                item.innerHTML = `<span>T·∫≠p ${idx + 1}</span> <i class="fa-solid fa-volume-high" style="display:none; font-size:12px"></i>`;
                item.onclick = () => { player.playVideoAt(idx); };
                container.appendChild(item);
            });
            highlightChapter(player.getPlaylistIndex());
        }
    }
    
    function highlightChapter(index) {
        document.querySelectorAll('.chapter-item').forEach(el => {
            el.classList.remove('active'); el.querySelector('i').style.display = 'none';
        });
        const activeItem = document.getElementById('chapter-' + index);
        if(activeItem) {
            activeItem.classList.add('active'); activeItem.querySelector('i').style.display = 'block';
            activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('track-info').innerText = "ƒêang ph√°t: T·∫≠p " + (index + 1);
        }
    }

    // --- 7. AUTO SAVE/LOAD ---
    function saveProgress() {
        if (!player || !currentPlaylistId) return;
        const data = {
            id: currentPlaylistId, name: currentPlaylistName,
            index: player.getPlaylistIndex(), time: player.getCurrentTime()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function checkSavedProgress() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const p = JSON.parse(saved);
            // Auto load nh∆∞ng kh√¥ng auto play ƒë·ªÉ tr√°nh phi·ªÅn
            loadTrackToPlayer(p.id, p.name, p.index, p.time, false);
            document.getElementById('track-name').innerText = p.name + " (Ti·∫øp t·ª•c)";
        }
    }

    function formatTime(s) {
        const m = Math.floor(s / 60); const sc = Math.floor(s % 60);
        return m + ":" + (sc < 10 ? "0" : "") + sc;
    }

    loadLibrary();
    
    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.player-right')) document.getElementById('speed-menu').classList.remove('show');
    });

</script>
</body>
</html>
