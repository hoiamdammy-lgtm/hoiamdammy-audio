<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">
    <title>Kho Truy·ªán ƒêam M·ªπ - Audio Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #000000;
            --bg-item: #121212;
            --bg-hover: #1e1e1e;
            --primary: #1db954;
            --text-main: #ffffff;
            --text-sub: #a7a7a7;
            --bar-height: 110px; /* TƒÉng chi·ªÅu cao ƒë·ªÉ d·ªÖ b·∫•m tr√™n mobile */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            overflow: hidden;
            display: flex; height: 100vh;
            flex-direction: column;
        }

        /* --- HEADER & LIST --- */
        .header {
            padding: 20px;
            border-bottom: 1px solid #333;
            background: #000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { margin: 0; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .main-content {
            flex: 1;
            overflow-y: auto; 
            padding: 10px;
            padding-bottom: 150px; /* Ch·ª´a ch·ªó cho Player */
        }

        /* Danh s√°ch d·∫°ng Text */
        .story-list { display: flex; flex-direction: column; gap: 8px; }
        .story-item { 
            background: var(--bg-item); 
            padding: 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: 1px solid #222;
            display: flex; align-items: flex-start; gap: 12px;
            transition: 0.2s;
        }
        .story-item:hover { background: var(--bg-hover); border-color: #444; }
        .story-item.playing { border-left: 4px solid var(--primary); background: #1a1a1a; }
        
        .story-icon { color: #555; margin-top: 3px; font-size: 14px; }
        .story-item.playing .story-icon { color: var(--primary); animation: pulse 1s infinite; }
        
        .story-info { flex: 1; }
        .story-name { font-size: 14px; font-weight: 500; line-height: 1.5; color: #eee; }
        .story-meta { font-size: 12px; color: #777; margin-top: 4px; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- PLAYER BAR --- */
        .player-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--bar-height);
            background: #090909; border-top: 1px solid #333;
            display: flex; flex-direction: column; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .progress-container { width: 100%; height: 4px; background: #333; cursor: pointer; position: relative; }
        .progress-filled { height: 100%; background: var(--primary); width: 0%; position: relative; }
        .progress-thumb { width: 12px; height: 12px; background: white; border-radius: 50%; position: absolute; right: -6px; top: -4px; opacity: 1; }

        .player-controls-wrapper { display: flex; flex-direction: column; padding: 10px 15px; gap: 8px; height: 100%; justify-content: center; }
        
        /* D√≤ng th√¥ng tin b√†i h√°t */
        .track-info-line { text-align: center; margin-bottom: 5px; }
        .track-name-display { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-status-display { font-size: 11px; color: var(--primary); margin-top: 2px; }

        /* D√≤ng n√∫t b·∫•m */
        .controls-line { display: flex; align-items: center; justify-content: space-between; }
        .main-controls { display: flex; align-items: center; gap: 20px; justify-content: center; flex: 1; }
        
        .btn-icon { background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; padding: 10px; }
        .btn-play { width: 45px; height: 45px; background: white; border-radius: 50%; color: black; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        
        /* Drawer danh s√°ch t·∫≠p */
        .chapter-drawer {
            position: fixed; right: -100%; top: 0; bottom: 0; width: 80%;
            background: #111; z-index: 200; transition: 0.3s;
            display: flex; flex-direction: column; box-shadow: -5px 0 20px black;
        }
        .chapter-drawer.open { right: 0; }
        .drawer-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .drawer-list { flex: 1; overflow-y: auto; }
        .chapter-item { padding: 12px 15px; border-bottom: 1px solid #222; color: #ccc; font-size: 14px; cursor: pointer; }
        .chapter-item.active { color: var(--primary); background: #1a1a1a; }

        /* N√∫t ·∫©n hi·ªán menu */
        .menu-btn { font-size: 12px; border: 1px solid #444; padding: 4px 8px; border-radius: 4px; color: #aaa; background: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1><i class="fa-solid fa-book-open"></i> KHO TRUY·ªÜN</h1>
        <button class="menu-btn" onclick="location.reload()">T·∫£i l·∫°i</button>
    </div>

    <div class="main-content">
        <div id="loading" style="text-align: center; padding: 20px; color: #666;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        <div class="story-list" id="playlist-container"></div>
    </div>

    <div id="youtube-iframe" style="position: absolute; top: -9999px; left: -9999px;"></div>

    <div class="player-bar">
        <div class="progress-container" id="progress-container" onclick="seekTo(event)">
            <div class="progress-filled" id="progress-filled"><div class="progress-thumb"></div></div>
        </div>

        <div class="player-controls-wrapper">
            <div class="track-info-line">
                <div class="track-name-display" id="track-name">Ch∆∞a ch·ªçn truy·ªán</div>
                <div class="track-status-display" id="track-info">--:--</div>
            </div>

            <div class="controls-line">
                <button class="btn-icon" onclick="toggleDrawer()"><i class="fa-solid fa-list-ol"></i></button>
                
                <div class="main-controls">
                    <button class="btn-icon" onclick="seek(-10)"><i class="fa-solid fa-rotate-left"></i></button>
                    <button class="btn-play" id="play-btn" onclick="togglePlay()"><i class="fa-solid fa-play"></i></button>
                    <button class="btn-icon" onclick="seek(10)"><i class="fa-solid fa-rotate-right"></i></button>
                </div>

                <button class="btn-icon" id="speed-btn" onclick="cycleSpeed()" style="font-size: 14px; font-weight: bold; width: 40px;">1x</button>
            </div>
        </div>
    </div>

    <div class="chapter-drawer" id="chapter-drawer">
        <div class="drawer-header">
            <span>Danh s√°ch t·∫≠p</span>
            <i class="fa-solid fa-xmark" onclick="toggleDrawer()"></i>
        </div>
        <div class="drawer-list" id="chapter-list-content"></div>
    </div>

<script>
    const SUPABASE_URL = 'https://lpeijpxqelyljkdjyfil.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_n95DoJPIr7_KgktuE5ilZg_7a0ICkcT';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let player;
    let isPlaying = false;
    let updateTimer;
    let currentPlaylistName = "";
    let currentPlaylistId = "";
    
    // --- LOAD DANH S√ÅCH (TEXT ONLY) ---
    async function loadLibrary() {
        const { data, error } = await db.from('playlists').select('*').order('id', { ascending: false });
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('playlist-container');

        if (data && data.length > 0) {
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'story-item';
                div.innerHTML = `
                    <div class="story-icon"><i class="fa-solid fa-circle-play"></i></div>
                    <div class="story-info">
                        <div class="story-name">${item.name}</div>
                        <div class="story-meta">ID: ${item.id} ‚Ä¢ Click ƒë·ªÉ nghe</div>
                    </div>
                `;
                div.onclick = () => {
                    // X√≥a class playing c≈©
                    document.querySelectorAll('.story-item').forEach(el => el.classList.remove('playing'));
                    div.classList.add('playing');
                    loadTrackToPlayer(item.playlist_id, item.name, 0, 0);
                };
                container.appendChild(div);
            });
        }
    }

    // --- YOUTUBE & BACKGROUND PLAY SETUP ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-iframe', {
            height: '200', width: '200', // K√≠ch th∆∞·ªõc nh·ªè, nh∆∞ng ph·∫£i c√≥ ƒë·ªÉ browser render
            playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 0 },
            events: { 
                'onStateChange': onPlayerStateChange,
                'onReady': checkSavedProgress
            }
        });
        
        // K√≠ch ho·∫°t Media Session (Hi·ªán control ngo√†i m√†n h√¨nh kh√≥a)
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => player.playVideo());
            navigator.mediaSession.setActionHandler('pause', () => player.pauseVideo());
            navigator.mediaSession.setActionHandler('previoustrack', () => player.previousVideo());
            navigator.mediaSession.setActionHandler('nexttrack', () => player.nextVideo());
            navigator.mediaSession.setActionHandler('seekbackward', () => { 
                player.seekTo(player.getCurrentTime() - 10, true); 
            });
            navigator.mediaSession.setActionHandler('seekforward', () => { 
                player.seekTo(player.getCurrentTime() + 10, true); 
            });
        }
    }

    function loadTrackToPlayer(playlistId, name, index, startSeconds, autoPlay = true) {
        currentPlaylistId = playlistId;
        currentPlaylistName = name;
        document.getElementById('track-name').innerText = name;
        document.getElementById('track-info').innerText = "ƒêang t·∫£i...";
        
        if(player && player.loadPlaylist) {
            if(autoPlay) player.loadPlaylist({list: playlistId, listType: 'playlist', index: index, startSeconds: startSeconds});
            else player.cuePlaylist({list: playlistId, listType: 'playlist', index: index, startSeconds: startSeconds});
            
            setTimeout(renderChapterList, 1500);
        }
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
            startTimer();
            if(!window.saveInterval) window.saveInterval = setInterval(saveProgress, 10000);
            
            // C·∫≠p nh·∫≠t m√†n h√¨nh kh√≥a
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `T·∫≠p ${player.getPlaylistIndex() + 1}`,
                    artist: currentPlaylistName,
                    artwork: [{ src: 'https://via.placeholder.com/512?text=AUDIO', sizes: '512x512', type: 'image/png' }]
                });
            }
            highlightChapter(player.getPlaylistIndex());

        } else {
            isPlaying = false;
            document.getElementById('play-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
            clearInterval(updateTimer);
            if(event.data == YT.PlayerState.PAUSED) saveProgress();
        }
    }

    function startTimer() {
        clearInterval(updateTimer);
        updateTimer = setInterval(() => {
            if (player && player.getCurrentTime) {
                const current = player.getCurrentTime();
                const duration = player.getDuration();
                if (duration > 0) {
                    const percent = (current / duration) * 100;
                    document.getElementById('progress-filled').style.width = percent + "%";
                    document.getElementById('track-info').innerText = `T·∫≠p ${player.getPlaylistIndex() + 1} ‚Ä¢ ${formatTime(current)} / ${formatTime(duration)}`;
                }
            }
        }, 500);
    }

    // --- CONTROLS ---
    function togglePlay() { isPlaying ? player.pauseVideo() : player.playVideo(); }
    function seek(sec) { if(player) player.seekTo(player.getCurrentTime() + sec, true); }
    
    function cycleSpeed() {
        const rates = [1, 1.25, 1.5, 2, 2.5];
        let current = player.getPlaybackRate();
        let next = rates[(rates.indexOf(current) + 1) % rates.length];
        player.setPlaybackRate(next);
        document.getElementById('speed-btn').innerText = next + "x";
    }

    // --- DRAWER ---
    function toggleDrawer() { document.getElementById('chapter-drawer').classList.toggle('open'); }
    
    function renderChapterList() {
        if(!player) return;
        const listIds = player.getPlaylist();
        const container = document.getElementById('chapter-list-content');
        container.innerHTML = "";
        if(listIds) {
            listIds.forEach((id, idx) => {
                const item = document.createElement('div');
                item.className = 'chapter-item';
                item.id = 'chap-' + idx;
                item.innerText = `T·∫≠p ${idx + 1}`;
                item.onclick = () => { player.playVideoAt(idx); toggleDrawer(); };
                container.appendChild(item);
            });
            highlightChapter(player.getPlaylistIndex());
        }
    }

    function highlightChapter(idx) {
        document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('active'));
        const active = document.getElementById('chap-' + idx);
        if(active) {
            active.classList.add('active');
            active.scrollIntoView({block: 'center'});
        }
    }

    // --- SAVE PROGRESS ---
    function saveProgress() {
        if(!player || !currentPlaylistId) return;
        localStorage.setItem('hoiam_v3', JSON.stringify({
            id: currentPlaylistId, name: currentPlaylistName,
            index: player.getPlaylistIndex(), time: player.getCurrentTime()
        }));
    }
    
    function checkSavedProgress() {
        const saved = localStorage.getItem('hoiam_v3');
        if(saved) {
            const p = JSON.parse(saved);
            loadTrackToPlayer(p.id, p.name, p.index, p.time, false);
            document.getElementById('track-name').innerText = p.name + " (Ti·∫øp t·ª•c)";
        }
    }

    function seekTo(e) {
        const rect = document.getElementById('progress-container').getBoundingClientRect();
        const p = (e.clientX - rect.left) / rect.width;
        if(player) player.seekTo(p * player.getDuration(), true);
    }

    function formatTime(s) {
        const m = Math.floor(s/60); const sc = Math.floor(s%60);
        return m + ":" + (sc<10?"0":"") + sc;
    }

    loadLibrary();
</script>
</body>
</html>
