<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">
    <title>H·ªìi √Çm ƒêam M·ªπ - Audio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-hover: #1e1e1e;
            --primary: #1db954;
            --text: #ffffff;
            --text-sub: #b3b3b3;
            --glass: rgba(20, 20, 20, 0.8);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER & FILTER */
        .header-container { padding: 20px 20px 10px; background: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 100%); z-index: 10; }
        .brand { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { 
            background: #222; border: 1px solid #333; color: var(--text); padding: 8px 16px; border-radius: 20px; 
            font-size: 13px; font-weight: 500; white-space: nowrap; cursor: pointer; transition: 0.2s; 
        }
        .filter-chip.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 700; }

        /* LIST CONTENT */
        .main-content { flex: 1; overflow-y: auto; padding: 10px 20px; padding-bottom: 140px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .story-card {
            background: var(--surface); border-radius: 12px; padding: 16px; 
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            border: 1px solid #222; transition: 0.2s; position: relative; overflow: hidden;
        }
        .story-card:hover { background: var(--surface-hover); border-color: #333; transform: translateY(-2px); }
        .story-card.playing { border-color: var(--primary); background: rgba(29, 185, 84, 0.1); }
        
        .card-icon { 
            width: 45px; height: 45px; background: #222; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #555; flex-shrink: 0;
        }
        .story-card.playing .card-icon { color: var(--primary); background: #000; }
        
        .card-info { flex: 1; min-width: 0; }
        .card-title { font-size: 15px; font-weight: 600; line-height: 1.4; color: #eee; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-tag { font-size: 11px; color: var(--text-sub); display: inline-block; background: #222; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }

        /* PLAYER BAR */
        .player-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 110px; 
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); border-top: 1px solid #222;
            display: flex; flex-direction: column; z-index: 100;
        }
        .progress-area { width: 100%; height: 4px; background: #333; cursor: pointer; position: relative; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; border-radius: 0 4px 4px 0; }
        
        .player-controls { display: flex; flex-direction: column; justify-content: center; height: 100%; padding: 0 20px; gap: 10px; }
        
        .track-display { text-align: center; }
        .track-name { font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-status { font-size: 11px; color: var(--primary); margin-top: 2px; letter-spacing: 0.5px; }

        .btn-row { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; }
        .main-btns { display: flex; align-items: center; gap: 25px; flex: 1; justify-content: center; }
        
        .btn { background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; padding: 5px; transition: 0.2s; }
        .btn:hover { color: #fff; }
        .btn-play { width: 48px; height: 48px; background: #fff; border-radius: 50%; color: #000; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .btn-play:hover { transform: scale(1.05); }

        /* DRAWER */
        .drawer { 
            position: fixed; top: 0; right: -100%; width: 85%; height: 100%; 
            background: #111; z-index: 200; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }
        .drawer-header { padding: 20px; border-bottom: 1px solid #222; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 10px; }
        .chapter-row { padding: 14px; border-bottom: 1px solid #1a1a1a; cursor: pointer; color: #bbb; font-size: 14px; border-radius: 6px; }
        .chapter-row:hover { background: #1a1a1a; color: #fff; }
        .chapter-row.active { color: var(--primary); background: #1a1a1a; font-weight: 600; }

        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .drawer { width: 350px; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="brand"><i class="fa-solid fa-bolt"></i> H·ªíI √ÇM AUDIO</div>
        <div class="filter-scroll">
            <div class="filter-chip active" onclick="filterData('all', this)">T·∫•t c·∫£</div>
            <div class="filter-chip" onclick="filterData('Ch·ªß Th·ª•', this)">Ch·ªß Th·ª•</div>
            <div class="filter-chip" onclick="filterData('Ch·ªß C√¥ng', this)">Ch·ªß C√¥ng</div>
            <div class="filter-chip" onclick="filterData('H·ªó C√¥ng', this)">H·ªó C√¥ng</div>
            <div class="filter-chip" onclick="filterData('V√¥ CP', this)">V√¥ CP</div>
            <div class="filter-chip" onclick="filterData('Kh√°c', this)">Kh√°c</div>
        </div>
    </div>

    <div class="main-content">
        <div id="loading" style="text-align: center; margin-top: 50px; color: #666;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> ƒêang t·∫£i kho truy·ªán...
        </div>
        <div class="grid" id="playlist-container"></div>
    </div>

    <div id="youtube-iframe" style="position: absolute; top: -9999px;"></div>

    <div class="player-bar">
        <div class="progress-area" id="progress-area" onclick="seekTo(event)">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="player-controls">
            <div class="track-display">
                <div class="track-name" id="track-name">S·∫µn s√†ng ph√°t</div>
                <div class="track-status" id="track-info">--:--</div>
            </div>
            <div class="btn-row">
                <button class="btn" onclick="toggleDrawer()"><i class="fa-solid fa-list-ul"></i></button>
                <div class="main-btns">
                    <button class="btn" onclick="seek(-10)"><i class="fa-solid fa-rotate-left"></i></button>
                    <button class="btn-play" id="play-btn" onclick="togglePlay()"><i class="fa-solid fa-play"></i></button>
                    <button class="btn" onclick="seek(10)"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
                <button class="btn" id="speed-btn" onclick="changeSpeed()" style="font-size: 13px; font-weight: 700; width: 40px;">1x</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <span>Danh S√°ch T·∫≠p</span>
            <i class="fa-solid fa-xmark" onclick="toggleDrawer()" style="cursor: pointer; padding: 5px;"></i>
        </div>
        <div class="drawer-content" id="chapter-list"></div>
    </div>

<script>
    const db = supabase.createClient('https://lpeijpxqelyljkdjyfil.supabase.co', 'sb_publishable_n95DoJPIr7_KgktuE5ilZg_7a0ICkcT');
    let fullData = [];
    let player;
    let isPlaying = false;
    let updateTimer;
    let currentId = "";
    let currentName = "";

    // 1. DATA & FILTER
    async function init() {
        const { data } = await db.from('playlists').select('*').order('id', {ascending: false});
        fullData = data || [];
        document.getElementById('loading').style.display = 'none';
        renderList(fullData);
    }

    function renderList(list) {
        const container = document.getElementById('playlist-container');
        container.innerHTML = "";
        list.forEach(item => {
            const el = document.createElement('div');
            el.className = 'story-card';
            // T·ª± ƒë·ªông g√°n nh√£n n·∫øu ch∆∞a c√≥ category (d·ª± ph√≤ng)
            let cat = item.category || 'Truy·ªán';
            
            el.innerHTML = `
                <div class="card-icon"><i class="fa-solid fa-headphones"></i></div>
                <div class="card-info">
                    <div class="card-title">${item.name}</div>
                    <span class="card-tag">${cat}</span>
                </div>
                <i class="fa-solid fa-play" style="color: #333; font-size: 12px;"></i>
            `;
            el.onclick = () => {
                document.querySelectorAll('.story-card').forEach(e => e.classList.remove('playing'));
                el.classList.add('playing');
                loadTrack(item.playlist_id, item.name, 0, 0);
            };
            container.appendChild(el);
        });
    }

    function filterData(type, btn) {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        if(type === 'all') renderList(fullData);
        else renderList(fullData.filter(i => i.category === type));
    }

    // 2. YOUTUBE CORE
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-iframe', {
            height: '10', width: '10',
            playerVars: { 'playsinline': 1, 'controls': 0 },
            events: { 'onStateChange': onStateChange, 'onReady': checkSave }
        });
        
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => player.playVideo());
            navigator.mediaSession.setActionHandler('pause', () => player.pauseVideo());
            navigator.mediaSession.setActionHandler('previoustrack', () => player.previousVideo());
            navigator.mediaSession.setActionHandler('nexttrack', () => player.nextVideo());
            navigator.mediaSession.setActionHandler('seekbackward', () => seek(-10));
            navigator.mediaSession.setActionHandler('seekforward', () => seek(10));
        }
    }

    function loadTrack(pid, name, idx, time, auto=true) {
        currentId = pid; currentName = name;
        document.getElementById('track-name').innerText = name;
        if(player && player.loadPlaylist) {
            const func = auto ? 'loadPlaylist' : 'cuePlaylist';
            player[func]({list: pid, listType: 'playlist', index: idx, startSeconds: time});
            setTimeout(renderChapters, 1500);
        }
    }

    function onStateChange(e) {
        if (e.data == YT.PlayerState.PLAYING) {
            isPlaying = true;
            document.getElementById('play-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
            startTimer();
            save();
            highlightChapter(player.getPlaylistIndex());
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `T·∫≠p ${player.getPlaylistIndex() + 1}`, artist: currentName,
                    artwork: [{ src: 'https://via.placeholder.com/512.png?text=AUDIO', type: 'image/png' }]
                });
            }
        } else {
            isPlaying = false;
            document.getElementById('play-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
            clearInterval(updateTimer);
        }
    }

    // 3. UTILS
    function startTimer() {
        clearInterval(updateTimer);
        updateTimer = setInterval(() => {
            if(!player || !player.getCurrentTime) return;
            const cur = player.getCurrentTime();
            const dur = player.getDuration();
            if(dur) {
                document.getElementById('progress-bar').style.width = (cur/dur*100) + "%";
                document.getElementById('track-info').innerText = `T·∫≠p ${player.getPlaylistIndex()+1} ‚Ä¢ ${fmt(cur)} / ${fmt(dur)}`;
            }
        }, 500);
    }

    function togglePlay() { isPlaying ? player.pauseVideo() : player.playVideo(); }
    function seek(s) { player.seekTo(player.getCurrentTime()+s, true); }
    function seekTo(e) { 
        const r = document.getElementById('progress-area').getBoundingClientRect();
        player.seekTo(((e.clientX - r.left)/r.width) * player.getDuration(), true);
    }
    function changeSpeed() {
        const s = [1, 1.25, 1.5, 2, 2.5];
        let n = s[(s.indexOf(player.getPlaybackRate()) + 1) % s.length];
        player.setPlaybackRate(n);
        document.getElementById('speed-btn').innerText = n + "x";
    }
    function fmt(s) { return Math.floor(s/60) + ":" + (Math.floor(s%60)<10?"0":"") + Math.floor(s%60); }
    
    function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); }
    function renderChapters() {
        const list = player.getPlaylist();
        const c = document.getElementById('chapter-list');
        c.innerHTML = "";
        if(list) list.forEach((_, i) => {
            const d = document.createElement('div');
            d.className = 'chapter-row'; d.id = 'chap-'+i;
            d.innerText = `T·∫≠p ${i+1}`;
            d.onclick = () => { player.playVideoAt(i); toggleDrawer(); };
            c.appendChild(d);
        });
        highlightChapter(player.getPlaylistIndex());
    }
    function highlightChapter(i) {
        document.querySelectorAll('.chapter-row').forEach(e=>e.classList.remove('active'));
        const el = document.getElementById('chap-'+i);
        if(el) { el.classList.add('active'); el.scrollIntoView({block:'center'}); }
    }

    function save() { 
        localStorage.setItem('hoiam_v4', JSON.stringify({id: currentId, name: currentName, idx: player.getPlaylistIndex(), t: player.getCurrentTime()})); 
    }
    function checkSave() {
        const s = JSON.parse(localStorage.getItem('hoiam_v4'));
        if(s) loadTrack(s.id, s.name, s.idx, s.t, false);
    }

    init();
</script>
</body>
</html>
